name: Run Lichess Bot (Direct Black Move from PGN)

on:
  workflow_dispatch:
    inputs:
      game_id:
        description: "ID de la partie Lichess"
        required: true
        type: string
      elo:
        description: "Elo simul√© par Stockfish (1350‚Äì2850)"
        required: false
        default: "1500"

permissions:
  contents: write

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Stockfish & Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install python-chess requests

      - name: Play best black move from PGN and update files
        env:
          LICHESS_BOT_TOKEN: ${{ secrets.LICHESS_BOT_TOKEN }}
          GAME_ID: ${{ github.event.inputs.game_id }}
          BOT_ELO: ${{ github.event.inputs.elo }}
        run: |
          mkdir -p data

          echo "‚ôüÔ∏è Game ID: $GAME_ID"

          # 1) T√©l√©charger le PGN brut depuis Lichess
          RESPONSE=$(curl -s -H "Authorization: Bearer $LICHESS_BOT_TOKEN" \
            "https://lichess.org/game/export/$GAME_ID?pgn=1&clocks=0&evals=0&literate=0")

          if [ -z "$RESPONSE" ]; then
            echo "‚ùå Impossible de r√©cup√©rer le PGN."
            exit 1
          fi

          echo "$RESPONSE" > data/game.pgn
          echo "‚úÖ PGN sauvegard√© dans data/game.pgn"

          # 2) Script Python
          cat > play_move.py <<'PY'
          import os, json, chess.pgn, chess.engine, requests
          from pathlib import Path
          from datetime import datetime, timezone

          game_id = os.environ["GAME_ID"]
          elo = int(os.environ.get("BOT_ELO", 1500))
          token = os.environ["LICHESS_BOT_TOKEN"]

          with open("data/game.pgn", "r", encoding="utf-8") as f:
              game = chess.pgn.read_game(f)

          board = game.board()
          moves_list = []
          for move in game.mainline_moves():
              san = board.san(move)
              moves_list.append(san)
              board.push(move)

          print("üìú Historique des coups :", " ".join(moves_list))

          if board.turn != chess.BLACK:
              print("‚ùå Ce n'est pas aux Noirs de jouer.")
              exit(0)

          engine = chess.engine.SimpleEngine.popen_uci("/usr/bin/stockfish")
          engine.configure({"UCI_LimitStrength": True, "UCI_Elo": elo})
          result = engine.play(board, chess.engine.Limit(time=1.0))
          move = result.move
          engine.quit()

          print(f"ü§ñ Coup choisi: {move.uci()}")

          # Appliquer le coup sur le plateau
          board.push(move)

          # Envoyer le coup √† Lichess
          url = f"https://lichess.org/api/board/game/{game_id}/move/{move.uci()}"
          headers = {"Authorization": f"Bearer {token}"}
          r = requests.post(url, headers=headers)
          print(f"üì§ POST {url} -> {r.status_code} {r.text}")
          if r.status_code != 200:
              exit(1)

          # Sauvegarde des fichiers apr√®s le coup
          fen_after = board.fen()
          Path("data/position.fen").write_text(fen_after, encoding="utf-8")

          Path("data/dernier_coup.json").write_text(
              json.dumps({
                  "dernier_coup": move.uci(),
                  "fen": fen_after,
                  "horodatage": datetime.now(timezone.utc).isoformat()
              }, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )

          history_file = Path("data/move_history.json")
          history = []
          if history_file.exists():
              try:
                  history = json.loads(history_file.read_text(encoding="utf-8"))
                  if not isinstance(history, list):
                      history = []
              except Exception:
                  history = []
          history.append({
              "couleur": "noir",
              "coup": move.uci(),
              "fen_apres": fen_after,
              "horodatage": datetime.now(timezone.utc).isoformat()
          })
          history_file.write_text(json.dumps(history, ensure_ascii=False, indent=2), encoding="utf-8")

          print("‚úÖ position.fen, dernier_coup.json, move_history.json mis √† jour")
          PY

          python3 play_move.py

      - name: Commit updated files
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/position.fen data/dernier_coup.json data/move_history.json
          git commit -m "MAJ apr√®s coup noir"
          git push
