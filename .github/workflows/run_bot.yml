name: Run Lichess Bot (One-Shot Black Move)

on:
  workflow_dispatch:
    inputs:
      game_id:
        description: "ID de la partie Lichess"
        required: true
        type: string
      elo:
        description: "Elo simulé par Stockfish (1350–2850)"
        required: false
        default: "1500"

permissions:
  contents: write

concurrency:
  group: run-bot
  cancel-in-progress: false

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # pas besoin de 6h pour un coup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone lichess-bot
        run: git clone https://github.com/lichess-bot-devs/lichess-bot.git

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lichess-bot-${{ hashFiles('lichess-bot/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lichess-bot-

      - name: Install Stockfish and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish jq
          python -m pip install --upgrade pip
          pip install -r lichess-bot/requirements.txt
          which stockfish
          stockfish --version

      - name: Load env variables
        run: |
          echo "LICHESS_BOT_TOKEN=${{ secrets.LICHESS_BOT_TOKEN }}" >> $GITHUB_ENV
          echo "LICHESS_BOT_USERNAME=${{ secrets.LICHESS_BOT_USERNAME }}" >> $GITHUB_ENV
          echo "BOT_ELO=${{ github.event.inputs.elo }}" >> $GITHUB_ENV
          echo "GAME_ID=${{ github.event.inputs.game_id }}" >> $GITHUB_ENV

      - name: Vérification du nom du bot
        run: |
          set -e
          mkdir -p data
          BOT_NAME=$(curl -s -H "Authorization: Bearer $LICHESS_BOT_TOKEN" https://lichess.org/api/account | jq -r '.username')
          echo "$BOT_NAME" > data/bot_name.txt
          if [ -n "$LICHESS_BOT_USERNAME" ] && [ "$BOT_NAME" != "$LICHESS_BOT_USERNAME" ]; then
            echo "❌ ERREUR : Le token ne correspond pas au compte attendu."
            exit 1
          fi

      - name: Write config.yml (accept all time controls + adjustable Elo)
        run: |
          mkdir -p lichess-bot
          cat > lichess-bot/config.yml <<YML
          token: "${LICHESS_BOT_TOKEN}"

          engine:
            name: stockfish
            protocol: uci
            cmd: /usr/bin/stockfish
            ponder: false
            uci_options:
              Threads: 2
              Hash: 128
              UCI_LimitStrength: true
              UCI_Elo: ${BOT_ELO}

          play:
            rated: false
            variants: [standard]
            time_controls: any
            log_moves: true

          challenge:
            allow_bot: false
            max_concurrent: 1

          abort_time: 20
          YML

      - name: Play black move in existing game
        working-directory: lichess-bot
        env:
          LICHESS_BOT_TOKEN: ${{ env.LICHESS_BOT_TOKEN }}
          GAME_ID: ${{ env.GAME_ID }}
        run: |
          echo "== Starting lichess-bot for game $GAME_ID =="
          python lichess-bot.py --join $GAME_ID -vv --logfile /dev/stdout
          echo "== Bot finished running, workflow ending =="
