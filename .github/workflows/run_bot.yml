name: Run Lichess Bot (Direct Black Move Live)

on:
  workflow_dispatch:
    inputs:
      elo:
        description: "Elo simul√©"
        required: true
        default: "1500"
      mode:
        description: "Mode de jeu (uci, random, depth)"
        required: false
        default: "uci"
      depth:
        description: "Profondeur max (uniquement si mode=depth)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # 1) R√©cup√©ration du d√©p√¥t
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Installer Stockfish + d√©pendances Python
      - name: Install Stockfish & Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish python3-pip jq
          python3 -m pip install --upgrade pip
          python3 -m pip install python-chess requests

      # 3) Jouer le coup noir (live avec account/playing)
      - name: Play best black move (live)
        env:
          LICHESS_BOT_TOKEN: ${{ secrets.LICHESS_BOT_TOKEN }}
          BOT_ELO: ${{ github.event.inputs.elo }}
          BOT_MODE: ${{ github.event.inputs.mode }}
          BOT_DEPTH: ${{ github.event.inputs.depth }}
        run: |
          mkdir -p data

          echo "üìÇ V√©rification bot_elo.txt avant lancement:"
          echo "$BOT_ELO" > data/bot_elo.txt
          cat data/bot_elo.txt

          # R√©cup√©rer infos partie en live
          GAME_JSON=$(curl -s -H "Authorization: Bearer $LICHESS_BOT_TOKEN" https://lichess.org/api/account/playing)
          GAME_ID=$(echo "$GAME_JSON" | jq -r '.nowPlaying[] | select(.isMyTurn == true and .color == "black") | .gameId')

          if [ -z "$GAME_ID" ] || [ "$GAME_ID" = "null" ]; then
            echo "‚ö†Ô∏è Aucune partie trouv√©e o√π c'est au bot noir de jouer."
            exit 0
          fi

          echo "‚ôüÔ∏è Partie d√©tect√©e: $GAME_ID"
          export GAME_ID

          # Sauvegarder JSON brut (debug/trace)
          echo "$GAME_JSON" > data/account_playing.json

          # Extraire FEN
          GAME_FEN=$(echo "$GAME_JSON" | jq -r '.nowPlaying[] | select(.gameId=="'"$GAME_ID"'") | .fen')
          echo "$GAME_FEN" > data/position_before_black.fen

          # Script Python pour jouer le coup noir
          cat > play_move.py <<'PY'
          import os, json, shutil, chess, chess.engine, requests, random
          from pathlib import Path
          from datetime import datetime, timezone

          data_dir = Path("data")
          game_id = os.environ["GAME_ID"]
          token = os.environ["LICHESS_BOT_TOKEN"]

          elo = int(os.environ.get("BOT_ELO", "1500"))
          mode = os.environ.get("BOT_MODE", "uci")
          depth = os.environ.get("BOT_DEPTH", "")

          fen_path = data_dir / "position_before_black.fen"
          fen = fen_path.read_text(encoding="utf-8").strip()
          board = chess.Board(fen)

          if board.is_game_over() or board.turn != chess.BLACK:
              print("‚ö†Ô∏è Partie termin√©e ou pas au tour des Noirs.")
              raise SystemExit(0)

          # === Choix du coup noir ===
          if mode == "random":
              move = random.choice(list(board.legal_moves))
          else:
              stockfish_path = shutil.which("stockfish")
              if not stockfish_path:
                  print("‚ùå Stockfish introuvable")
                  raise SystemExit(1)
              engine = chess.engine.SimpleEngine.popen_uci(stockfish_path)
              if mode == "depth" and depth.isdigit():
                  result = engine.play(board, chess.engine.Limit(depth=int(depth)))
              else:
                  engine.configure({"UCI_LimitStrength": True, "UCI_Elo": elo})
                  result = engine.play(board, chess.engine.Limit(time=1.0))
              move = result.move
              engine.quit()

          # Calcul SAN du coup noir
          san_move = board.san(move)
          uci_move = move.uci()
          print(f"ü§ñ Coup choisi: {san_move} ({uci_move})")

          # Pousser le coup localement
          board.push(move)

          # Envoi √† Lichess
          url = f"https://lichess.org/api/bot/game/{game_id}/move/{uci_move}"
          headers = {"Authorization": f"Bearer {token}"}
          r = requests.post(url, headers=headers)
          print(f"üì§ POST {url} -> {r.status_code} {r.text}")
          if r.status_code != 200:
              print(f"‚ö†Ô∏è Coup envoy√© mais r√©ponse non-200: {r.status_code} {r.text}")
              # On continue quand m√™me

          # Sauvegarde FEN + dernier coup lisible
          fen_after_local = board.fen()
          (data_dir / "position.fen").write_text(fen_after_local, encoding="utf-8")
          (data_dir / "dernier_coup.json").write_text(
              json.dumps({
                  "dernier_coup": san_move,
                  "fen": fen_after_local,
                  "horodatage": datetime.now(timezone.utc).isoformat()
              }, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )

          # === TEST: √©crire directement "test" dans historique.txt ===
          with open(data_dir / "historique.txt", "a", encoding="utf-8") as f:
              f.write("test\n")
          print("‚úçÔ∏è Test √©crit dans historique.txt")

          # === Historique: coup blanc depuis fichier + coup noir depuis lastMove ===
          try:
              coup_blanc_file = data_dir / "coup_blanc.txt"
              dernier_coup_blanc = coup_blanc_file.read_text(encoding="utf-8").strip() if coup_blanc_file.exists() else None

              coup_noir_uci = None
              ap = requests.get(
                  "https://lichess.org/api/account/playing",
                  headers={"Authorization": f"Bearer {token}"},
                  timeout=15
              )
              if ap.status_code == 200:
                  j = ap.json()
                  for g in j.get("nowPlaying", []):
                      if g.get("gameId") == game_id:
                          coup_noir_uci = g.get("lastMove")
                          break

              dernier_coup_noir = coup_noir_uci
              try:
                  if coup_noir_uci:
                      tmp_board = chess.Board(fen_after_local)
                      tmp_board.pop()
                      move_obj = chess.Move.from_uci(coup_noir_uci)
                      dernier_coup_noir = tmp_board.san(move_obj)
              except Exception:
                  pass

              move_number = board.fullmove_number
              if dernier_coup_blanc and dernier_coup_noir:
                  line = f"{move_number}. {dernier_coup_blanc} {dernier_coup_noir}\n"
              elif dernier_coup_noir:
                  line = f"{move_number}... {dernier_coup_noir}\n"
              else:
                  line = f"{move_number}. ? ?\n"

              with open(data_dir / "historique.txt", "a", encoding="utf-8") as f:
                  f.write(line)

              print(f"‚úÖ historique.txt mis √† jour (nouvelle logique): {line.strip()}")
          except Exception as e:
              print(f"‚ùå Erreur mise √† jour historique.txt: {e}")

          # Mise √† jour move_history.json
          history_file = data_dir / "move_history.json"
          history = []
          if history_file.exists():
              try:
                  parsed = json.loads(history_file.read_text(encoding="utf-8"))
                  if isinstance(parsed, list):
                      history = parsed
              except Exception:
                  pass

          entry = {
              "couleur": "noir",
              "coup": uci_move,
              "fen_apres": fen_after_local,
              "horodatage": datetime.now(timezone.utc).isoformat()
          }
          history.append(entry)
          history_file.write_text(
              json.dumps(history, ensure_ascii=False, indent=2),
              encoding="utf-8"
          )
          print("‚úÖ move_history.json mis √† jour (coup noir consign√©)")
          PY

          python3 play_move.py

      # 3.5) Debug avant commit
      - name: Debug files before commit
        run: |
          echo "=== LS DATA ==="
          ls -la data
          echo "=== CONTENU historique.txt ==="
          cat data/historique.txt || echo "‚ùå historique.txt introuvable"
          echo "=== GIT STATUS ==="
          git status --short

      # 4) Commit & push (force direct, pas de rebase)
      - name: Commit & Push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/position.fen data/dernier_coup.json data/move_history.json data/historique.txt || true
          git diff --cached --quiet || git commit -m "MAJ apr√®s coup noir"
          git push origin main --force
