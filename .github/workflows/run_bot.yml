name: Run Lichess Bot (Direct Black Move via API)

on:
  workflow_dispatch:
    inputs:
      game_id:
        description: "ID de la partie Lichess"
        required: true
        type: string
      elo:
        description: "Elo simul√© par Stockfish (1350‚Äì2850)"
        required: false
        default: "1500"

permissions:
  contents: write

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Install Stockfish & Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish python3-pip jq
          python3 -m pip install --upgrade pip
          python3 -m pip install python-chess requests

      - name: Play best black move directly
        env:
          LICHESS_BOT_TOKEN: ${{ secrets.LICHESS_BOT_TOKEN }}
          GAME_ID: ${{ github.event.inputs.game_id }}
          BOT_ELO: ${{ github.event.inputs.elo }}
        run: |
          echo "‚ôüÔ∏è Game ID: $GAME_ID"
          
          # 1) R√©cup√©rer la FEN actuelle
          FEN=$(curl -s -H "Authorization: Bearer $LICHESS_BOT_TOKEN" \
            "https://lichess.org/game/export/$GAME_ID?fen=1&moves=0" \
            | jq -r '.fen')
          
          if [ -z "$FEN" ] || [ "$FEN" = "null" ]; then
            echo "‚ùå Impossible de r√©cup√©rer la FEN."
            exit 1
          fi
          echo "üìå FEN actuelle: $FEN"

          # 2) Trouver le meilleur coup avec Stockfish
          cat > play_move.py <<'PY'
import os, chess, chess.engine, requests

fen = os.environ["FEN"]
game_id = os.environ["GAME_ID"]
elo = int(os.environ.get("BOT_ELO", 1500))
token = os.environ["LICHESS_BOT_TOKEN"]

board = chess.Board(fen)
if board.turn != chess.BLACK:
    print("‚ùå Ce n'est pas aux Noirs de jouer.")
    exit(0)

engine = chess.engine.SimpleEngine.popen_uci("/usr/bin/stockfish")
engine.configure({"UCI_LimitStrength": True, "UCI_Elo": elo})
result = engine.play(board, chess.engine.Limit(time=1.0))
move = result.move
engine.quit()

print(f"ü§ñ Coup choisi: {move.uci()}")

# 3) Envoyer le coup √† Lichess
url = f"https://lichess.org/api/board/game/{game_id}/move/{move.uci()}"
r = requests.post(url, headers={"Authorization": f"Bearer {token}"})
print(f"üì§ POST {url} -> {r.status_code} {r.text}")
PY

          # 3bis) Ex√©cuter le script Python
          FEN="$FEN" GAME_ID="$GAME_ID" BOT_ELO="$BOT_ELO" python3 play_move.py
